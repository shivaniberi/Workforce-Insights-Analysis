{{ config(materialized='table') }}
WITH historical_data AS (
    SELECT
        JOB_TITLE,
        LOCATION,
        AVG((SALARY_MIN + SALARY_MAX) / 2) AS AVERAGE_SALARY,
        COUNT(JOB_ID) AS JOB_DEMAND,
        DATE_TRUNC('month', CREATED_DATE) AS TREND_MONTH -- Use CREATED_DATE
    FROM {{ ref('stg_job_listings_history') }}
    GROUP BY JOB_TITLE, LOCATION, TREND_MONTH
),
real_time_data AS (
    SELECT
        JOB_TITLE,
        LOCATION,
        AVG((SALARY_MIN + SALARY_MAX) / 2) AS AVERAGE_SALARY,
        COUNT(JOB_ID) AS JOB_DEMAND,
        DATE_TRUNC('month', CREATED_DATE) AS TREND_MONTH -- Use CREATED_DATE
    FROM {{ ref('stg_job_listings') }}
    GROUP BY JOB_TITLE, LOCATION, TREND_MONTH
)
SELECT
    COALESCE(h.JOB_TITLE, r.JOB_TITLE) AS JOB_TITLE,
    COALESCE(h.LOCATION, r.LOCATION) AS LOCATION,
    COALESCE(h.TREND_MONTH, r.TREND_MONTH) AS TREND_MONTH,
    COALESCE(h.AVERAGE_SALARY, 0) + COALESCE(r.AVERAGE_SALARY, 0) AS AVERAGE_SALARY,
    COALESCE(h.JOB_DEMAND, 0) + COALESCE(r.JOB_DEMAND, 0) AS JOB_DEMAND
FROM historical_data h
FULL OUTER JOIN real_time_data r
    ON h.JOB_TITLE = r.JOB_TITLE
    AND h.LOCATION = r.LOCATION
    AND h.TREND_MONTH = r.TREND_MONTH

